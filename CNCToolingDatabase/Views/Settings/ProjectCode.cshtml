@model List<CNCToolingDatabase.Models.ProjectCode>
@{
    ViewData["Title"] = "Settings - Project Code";
}

<div class="module-header">
    <h2>Project Code Management</h2>
    <div style="display: flex; gap: 0.5rem;">
        <button type="button" class="btn btn-primary" onclick="openCreateModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Project Code
        </button>
        <button type="button" class="btn btn-secondary" onclick="resetFromSeed()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Reset
        </button>
    </div>
</div>

<div class="search-bar">
    <form method="get" id="searchForm">
        <input type="hidden" name="sortColumn" value="@ViewBag.SortColumn" />
        <input type="hidden" name="sortDirection" value="@ViewBag.SortDirection" />
        <div class="search-input-group">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" name="search" value="@ViewBag.Search" placeholder="Search project codes, customers, or projects..." class="search-input" id="searchInput" />
        </div>
    </form>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th onclick="sortBy('id')">No. @Html.Raw(GetSortIcon("id", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th onclick="sortBy('code')">Code @Html.Raw(GetSortIcon("code", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th onclick="sortBy('customer')">Customer @Html.Raw(GetSortIcon("customer", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th onclick="sortBy('project')">Project @Html.Raw(GetSortIcon("project", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th onclick="sortBy('createdby')">Created By @Html.Raw(GetSortIcon("createdby", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th onclick="sortBy('createddate')">Created Date @Html.Raw(GetSortIcon("createddate", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th onclick="sortBy('isactive')">Status @Html.Raw(GetSortIcon("isactive", ViewBag.SortColumn as string, ViewBag.SortDirection as string))</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Count == 0)
            {
                <tr>
                    <td colspan="8" class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <p>No project codes found</p>
                    </td>
                </tr>
            }
            else
            {
                @for (int i = 0; i < Model.Count; i++)
                {
                    var item = Model[i];
                    var no = ((int)(ViewBag.CurrentPage ?? 1) - 1) * (int)(ViewBag.PageSize ?? 250) + i + 1;
                    <tr>
                        <td>@no</td>
                        <td>@item.Code</td>
                        <td>@(item.Description ?? "-")</td>
                        <td>@(item.Project ?? "-")</td>
                        <td>@item.CreatedBy</td>
                        <td>@item.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>
                            @if (item.IsActive)
                            {
                                <span class="status-badge status-available">Active</span>
                            }
                            else
                            {
                                <span class="status-badge status-locked">Inactive</span>
                            }
                        </td>
                        <td>
                            @{ var custJs = (item.Description ?? "").Replace("\\", "\\\\").Replace("'", "\\'"); var codeJs = (item.Code ?? "").Replace("\\", "\\\\").Replace("'", "\\'"); var projJs = (item.Project ?? "").Replace("\\", "\\\\").Replace("'", "\\'"); }
                            <button type="button" class="btn btn-secondary btn-sm" onclick="editItem(@item.Id, '@Html.Raw(codeJs)', '@Html.Raw(custJs)', '@Html.Raw(projJs)', @item.IsActive.ToString().ToLower())">Edit</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteItem(@item.Id, '@item.Code')">Delete</button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@if (ViewBag.TotalItems > 0)
{
    @await Html.PartialAsync("_Pagination", new PaginationViewModel
    {
        CurrentPage = (int)ViewBag.CurrentPage,
        TotalPages = Math.Max(1, (int)ViewBag.TotalPages),
        TotalItems = (int)ViewBag.TotalItems,
        PageSize = (int)ViewBag.PageSize,
        QueryBase = (string)(ViewBag.PaginationQuery ?? "")
    })
}

<!-- Create/Edit Modal -->
<div class="modal" id="itemModal">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add Project Code</h3>
            <button type="button" class="btn-icon" onclick="closeModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="itemForm">
                <input type="hidden" id="itemId" />
                <div class="form-group">
                    <label for="code">Code *</label>
                    <input type="text" id="code" class="form-control" required oninput="maybeAutoFillProject()" onchange="maybeAutoFillProject()" />
                </div>
                <div class="form-group">
                    <label for="customer">Customer</label>
                    <select id="customer" class="form-control">
                        <option value="">-- Select Customer --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="project">Project</label>
                    <select id="project" class="form-control">
                        <option value="">-- Select Project --</option>
                    </select>
                </div>
                <div class="form-group" id="isActiveGroup" style="display: none;">
                    <label>
                        <input type="checkbox" id="isActive" /> Active
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            document.getElementById('searchForm').submit();
        }, 300);
    });
    
    function sortBy(column) {
        const params = new URLSearchParams(window.location.search);
        const currentSort = params.get('sortColumn');
        const currentDir = params.get('sortDirection');
        params.set('sortColumn', column);
        params.set('sortDirection', (currentSort === column && currentDir === 'asc') ? 'desc' : 'asc');
        params.set('page', '1');
        window.location.href = '/Settings/ProjectCode?' + params.toString();
    }
    
    const CUSTOMERS = [
        'Airbus', 'Airbus Atlantic', 'Airbus Germany', 'Celestica', 'CTRM Aerosystems',
        'GKN Aerospace', 'Honeywell', 'Meggitt Akrons Braking Systems', 'Meggitt Coventry',
        'Meggitt Sensing System', 'Plexus', 'SAM', 'Senior Aerospace Thailand', 'Senior Ermeto',
        'Senior SSP', 'SOGERMA, FRENCH', 'Spirit Aerosystems', 'Stelia Aerospace', 'UTAS India',
        'UTAS / CTRM', 'UTAS US'
    ];
    
    const CODE_PROJECT = {
        'AB01': 'Engine Casing', 'AB02': 'Panther', 'AB03': 'UTAS A350 Component',
        'AD01': 'MCS-C', 'AD02': 'MSS-F', 'AD03': 'MABS A',
        'AE01': 'Honeywell', 'AE02': 'Celestica Localisation', 'AE03': 'DU1080', 'AE04': 'Plexus', 'AE05': 'VMI PULL',
        'AG01': 'A350 XWB', 'AG02': 'A320 FTB-6B', 'AG03': 'Spirit Subang A320 6C', 'AG04': 'SPIRIT EPIPHRON TTI & CR',
        'AG05': 'Spirit Wave 4', 'AG06': 'WAVE 5', 'AG07': 'A321 XLR', 'AG08': 'SPIRIT GOLD', 'AG09': 'SINARAN A320 CA',
        'AH01': 'Goodrich', 'AH02': '787 Fan Cowl', 'AH03': 'A350 Fan Cowl', 'AH04': 'Motor Controller Plates', 'AH05': 'C-Series & MRJ Fan Cowl',
        'AJ01': 'Celestica HS',
        'AL01': 'A350 SOGERMA', 'AL02': 'A321 S14A SOGERMA', 'AL03': 'Celeste Seat', 'AL04': 'A350 MLGB', 'AL05': 'Celeste Seat 2nd Package',
        'AL06': 'AIRBUS D2P SBMSA', 'AL07': 'STELIA D2P SBMSA', 'AL08': 'SAT D2P', 'AL09': 'SAT D2P', 'AL10': 'Airbus Atlantic NPI & SB76',
        'AL11': 'AIRBUS GERMANY SA-A350', 'AL12': 'AIRBUS GERMANY SA-A350-KPDD-VAR',
        'AM01': 'MC130 & MC133', 'AM03': 'GKN A350 TE', 'AM04': 'GKN A330 BEARING ASSY',
        'AOG': 'Airbus',
        'AP02': 'FHI-SAT Fitting',
        'AQ01': 'A350 XWB',
        'SA01': 'SSP A320 Neo & C-Series Flanges', 'SB01': 'Senior Ermeto'
    };
    
    const PROJECTS = [...new Set(Object.values(CODE_PROJECT))].sort();
    
    function fillCustomerOptions(selectedValue) {
        const sel = document.getElementById('customer');
        sel.innerHTML = '<option value="">-- Select Customer --</option>';
        const seen = new Set(['']);
        for (const c of CUSTOMERS) {
            if (!seen.has(c)) { seen.add(c); sel.appendChild(new Option(c, c)); }
        }
        if (selectedValue && !CUSTOMERS.includes(selectedValue)) {
            sel.appendChild(new Option(selectedValue, selectedValue));
        }
        sel.value = selectedValue || '';
    }
    
    function fillProjectOptions(selectedValue) {
        const sel = document.getElementById('project');
        sel.innerHTML = '<option value="">-- Select Project --</option>';
        for (const p of PROJECTS) {
            sel.appendChild(new Option(p, p));
        }
        if (selectedValue && !PROJECTS.includes(selectedValue)) {
            sel.appendChild(new Option(selectedValue, selectedValue));
        }
        sel.value = selectedValue || '';
    }
    
    function maybeAutoFillProject() {
        const codeEl = document.getElementById('code');
        if (codeEl.disabled) return;
        const code = codeEl.value.trim().toUpperCase();
        const proj = document.getElementById('project');
        if (code && CODE_PROJECT[code] && (!proj.value || proj.value === CODE_PROJECT[code])) {
            proj.value = CODE_PROJECT[code];
        }
    }
    
    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Add Project Code';
        document.getElementById('itemForm').reset();
        document.getElementById('itemId').value = '';
        document.getElementById('code').disabled = false;
        fillCustomerOptions('');
        fillProjectOptions('');
        document.getElementById('isActiveGroup').style.display = 'none';
        document.getElementById('itemModal').classList.add('active');
    }
    
    function editItem(id, code, customer, project, isActive) {
        document.getElementById('modalTitle').textContent = 'Edit Project Code';
        document.getElementById('itemId').value = id;
        document.getElementById('code').value = code;
        document.getElementById('code').disabled = true;
        fillCustomerOptions(customer || '');
        fillProjectOptions(project || '');
        document.getElementById('isActive').checked = isActive;
        document.getElementById('isActiveGroup').style.display = 'block';
        document.getElementById('itemModal').classList.add('active');
    }
    
    function deleteItem(id, code) {
        if (!confirm(`Are you sure you want to delete project code "${code}"?`)) {
            return;
        }
        
        fetch('/Settings/DeleteProjectCode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + id
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
    
    function resetFromSeed() {
        if (!confirm('This will delete all current project code data and restore seed data only. This action cannot be undone.\n\nDo you want to continue?')) return;
        fetch('/Settings/ResetProjectCode', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: '' })
            .then(r => r.json())
            .then(data => { if (data.success) location.reload(); else alert('Error: ' + data.message); })
            .catch(e => alert('Error: ' + e.message));
    }
    
    function closeModal() {
        document.getElementById('itemModal').classList.remove('active');
        document.getElementById('code').disabled = false;
    }
    
    document.getElementById('code').addEventListener('blur', maybeAutoFillProject);
    
    document.getElementById('itemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const itemId = document.getElementById('itemId').value;
        const code = document.getElementById('code').value;
        const customer = document.getElementById('customer').value;
        const project = document.getElementById('project').value;
        const isActive = document.getElementById('isActive').checked;
        
        let url = '/Settings/CreateProjectCode';
        let body = `code=${encodeURIComponent(code)}&description=${encodeURIComponent(customer)}&project=${encodeURIComponent(project)}`;
        
        if (itemId) {
            url = '/Settings/UpdateProjectCode';
            body = `id=${itemId}&description=${encodeURIComponent(customer)}&project=${encodeURIComponent(project)}&isActive=${isActive}`;
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body
            });
            const result = await response.json();
            
            if (result.success) {
                closeModal();
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
</script>
}

@functions {
    string GetSortIcon(string column, string sortColumn, string sortDirection)
    {
        if (sortColumn?.ToLower() == column?.ToLower())
            return sortDirection?.ToLower() == "desc" ? "<span class='sort-icon'>&#9660;</span>" : "<span class='sort-icon'>&#9650;</span>";
        return "<span class='sort-icon sort-inactive'>&#9650;&#9660;</span>";
    }
}
